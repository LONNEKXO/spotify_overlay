<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify Now Playing Overlay</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: transparent; /* <-- STRONA PRZEZROCZYSTA */
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:#e9ecff;
    }

    :root{
      --card-bg: rgba(12,14,30,.88);   /* <-- widget NIE jest przezroczysty */
      --stroke: rgba(97,103,170,.35);
      --pink:#ff5aa6;
      --mauve:#b06cff;
      --radius: 22px;
    }

    /* pozycja overlay */
    .wrap{
      position:fixed;
      left:42px;
      bottom:42px;
      z-index:10;
      /* szerokość będzie ustawiana JS-em (dynamicznie) */
    }

    .card{
      display:inline-flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border-radius:999px;
      background: var(--card-bg);
      border:1px solid var(--stroke);
      box-shadow: 0 18px 45px rgba(0,0,0,.55);
      position:relative;
      overflow:hidden;
      transform: translateZ(0);
      will-change: width;
      transition: width .22s ease, transform .22s ease, opacity .22s ease;
    }

    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(260px 160px at 0% 0%, rgba(255,90,166,.25), transparent 60%),
        radial-gradient(260px 160px at 100% 100%, rgba(176,108,255,.18), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }

    /* okładka */
    .cover{
      width:54px; height:54px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      flex:0 0 auto;
      position:relative;
      z-index:1;
      background: rgba(255,255,255,.06);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .cover img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }

    /* kręcąca się płyta */
    .vinyl{
      width:54px; height:54px;
      flex:0 0 auto;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      position:relative;
      z-index:1;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.65) 0 2px,
          rgba(0,0,0,.0) 2px 7px,
          rgba(255,255,255,.16) 7px 8px,
          rgba(0,0,0,.0) 8px 12px,
          rgba(255,255,255,.14) 12px 13px,
          rgba(0,0,0,.0) 13px 18px,
          rgba(255,255,255,.10) 18px 19px,
          rgba(0,0,0,.0) 19px 100%
        ),
        radial-gradient(circle at 30% 30%, rgba(255,90,166,.20), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(176,108,255,.18), transparent 55%),
        rgba(0,0,0,.28);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      transform-origin: 50% 50%;
    }
    .vinyl::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      opacity:.8;
    }
    .spin{
      animation: spin 2.2s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      z-index:1;
      position:relative;
    }
    .artist{
      font-size:13px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow:0 0 14px rgba(176,108,255,.35);
      max-width: 62vw; /* fallback */
    }
    .track{
      font-size:12px;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#ffe6f6;
      text-shadow:0 0 14px rgba(255,90,166,.30);
      max-width: 62vw; /* fallback */
    }

    .pill{
      margin-left:10px;
      font-size:10px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,90,166,.55);
      background: radial-gradient(circle at 0 0,
        rgba(255,90,166,.22),
        rgba(176,108,255,.12)
      );
      color:#ffe6f6;
      text-transform:uppercase;
      letter-spacing:.16em;
      font-weight:900;
      user-select:none;
      z-index:1;
      position:relative;
      white-space:nowrap;
    }

    /* idle */
    .idle .artist{ opacity:.75; }
    .idle .track{ opacity:.6; }
    .idle .vinyl{ opacity:.65; }
    .idle .cover{ opacity:.65; }

    /* responsive */
    @media (max-width:780px){
      .wrap{ left:18px; bottom:18px; }
      .card{ border-radius:22px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div id="card" class="card idle">
      <div class="vinyl" id="vinyl"></div>
      <div class="cover">
        <img id="coverImg" alt="Okładka utworu" />
      </div>

      <div class="meta">
        <div id="artist" class="artist">Spotify</div>
        <div id="track" class="track">Łączenie…</div>
      </div>

      <div id="pill" class="pill">OFF</div>
    </div>
  </div>

  <script>
    /**********************
     * USTAW:
     **********************/
    const SPOTIFY_CLIENT_ID = "0ed7689f271f4ba0afde04674e676e71";
    // MUSI BYĆ identyczne jak Redirect URI w Spotify Developer
    const REDIRECT_URI = "https://lonnekxo.github.io/spotify_overlay/";
    const SCOPES = [
      "user-read-currently-playing",
      "user-read-playback-state"
    ].join(" ");

    /**********************
     * UI
     **********************/
    const card = document.getElementById("card");
    const vinyl = document.getElementById("vinyl");
    const coverImg = document.getElementById("coverImg");
    const artistEl = document.getElementById("artist");
    const trackEl = document.getElementById("track");
    const pill = document.getElementById("pill");

    function setIdle(a, t){
      card.classList.add("idle");
      pill.textContent = "OFF";
      vinyl.classList.remove("spin");
      artistEl.textContent = a ?? "Nic nie gra";
      trackEl.textContent = t ?? "—";
      coverImg.removeAttribute("src");
      resizeCardToText();
    }

    function setPlaying({artist, track, imageUrl}){
      card.classList.remove("idle");
      pill.textContent = "ON";
      vinyl.classList.add("spin");
      artistEl.textContent = artist || "—";
      trackEl.textContent = track || "—";
      if (imageUrl) coverImg.src = imageUrl;
      resizeCardToText();
    }

    /**********************
     * Auto-resize szerokości karty pod tekst
     * (żeby overlay się “rozszerzał i zwężał”)
     **********************/
    const measureCanvas = document.createElement("canvas");
    const mctx = measureCanvas.getContext("2d");

    function textWidth(text, font){
      mctx.font = font;
      return mctx.measureText(text).width;
    }

    function resizeCardToText(){
      // pobieramy aktualne fonty z DOM, żeby pomiar był realny
      const artistStyle = getComputedStyle(artistEl);
      const trackStyle = getComputedStyle(trackEl);

      const artistFont = `${artistStyle.fontWeight} ${artistStyle.fontSize} ${artistStyle.fontFamily}`;
      const trackFont  = `${trackStyle.fontWeight} ${trackStyle.fontSize} ${trackStyle.fontFamily}`;

      const wA = textWidth(artistEl.textContent || "", artistFont);
      const wT = textWidth(trackEl.textContent || "", trackFont);
      const textW = Math.max(wA, wT);

      // stałe elementy: vinyl + cover + padding + pill + gaps
      // to jest “na oko” + margines, żeby nie ucinało
      const fixed = 54 + 54 + 14*2 + 12*3 + 10 + 56; // ~ vin/cover/padding/gaps/pill
      const target = fixed + textW;

      const minW = 320;
      const maxW = Math.min(window.innerWidth - 84, 900);

      const finalW = Math.max(minW, Math.min(maxW, Math.round(target)));
      card.style.width = finalW + "px";
    }

    window.addEventListener("resize", resizeCardToText);

    /**********************
     * PKCE helpers
     **********************/
    function base64UrlEncode(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }
    async function sha256(plain) {
      const enc = new TextEncoder();
      return await crypto.subtle.digest("SHA-256", enc.encode(plain));
    }
    function randomString(len = 64){
      const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";
      const arr = new Uint32Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr, x => chars[x % chars.length]).join("");
    }

    function saveTokens({access_token, refresh_token, expires_in}){
      const expiresAt = Date.now() + (expires_in * 1000) - 10_000;
      localStorage.setItem("sp_access_token", access_token);
      if (refresh_token) localStorage.setItem("sp_refresh_token", refresh_token);
      localStorage.setItem("sp_expires_at", String(expiresAt));
    }
    function clearTokens(){
      localStorage.removeItem("sp_access_token");
      localStorage.removeItem("sp_refresh_token");
      localStorage.removeItem("sp_expires_at");
      localStorage.removeItem("sp_code_verifier");
    }
    function getAccessToken(){ return localStorage.getItem("sp_access_token"); }
    function tokenExpired(){
      const t = Number(localStorage.getItem("sp_expires_at") || "0");
      return !t || Date.now() > t;
    }

    async function refreshAccessToken(){
      const refresh_token = localStorage.getItem("sp_refresh_token");
      if (!refresh_token) return null;

      const body = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        grant_type: "refresh_token",
        refresh_token
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body
      });

      if (!res.ok) return null;

      const data = await res.json();
      saveTokens(data);
      return data.access_token;
    }

    async function startLoginAuto(){
      // “automatyczny connect”:
      // jeżeli nie mamy tokenów, robimy redirect do Spotify od razu.
      // (pierwszy raz i tak musisz zaakceptować zgodę w Spotify)
      if (!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes("WSTAW_TU")) {
        setIdle("Brak Client ID", "Wklej SPOTIFY_CLIENT_ID");
        return;
      }

      const code_verifier = randomString(64);
      localStorage.setItem("sp_code_verifier", code_verifier);
      const challenge = base64UrlEncode(await sha256(code_verifier));

      const params = new URLSearchParams({
        response_type: "code",
        client_id: SPOTIFY_CLIENT_ID,
        scope: SCOPES,
        redirect_uri: REDIRECT_URI,
        code_challenge_method: "S256",
        code_challenge: challenge,
      });

      window.location.href = "https://accounts.spotify.com/authorize?" + params.toString();
    }

    async function handleCallbackIfNeeded(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      const error = url.searchParams.get("error");

      if (error){
        setIdle("Błąd Spotify", error);
        return;
      }
      if (!code) return;

      const code_verifier = localStorage.getItem("sp_code_verifier");
      if (!code_verifier){
        setIdle("Brak PKCE", "Wyczyść localStorage i odśwież");
        return;
      }

      const body = new URLSearchParams({
        client_id: SPOTIFY_CLIENT_ID,
        grant_type: "authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier
      });

      const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body
      });

      if (!res.ok){
        setIdle("Token exchange fail", "Sprawdź Redirect URI");
        return;
      }

      const data = await res.json();
      saveTokens(data);

      // sprzątamy URL
      url.searchParams.delete("code");
      url.searchParams.delete("state");
      window.history.replaceState({}, document.title, url.toString());
    }

    async function spotifyCurrentlyPlaying(token){
      const res = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers: { Authorization: "Bearer " + token }
      });

      if (res.status === 204) return { isPlaying:false };
      if (res.status === 401) return { unauthorized:true };
      if (!res.ok) return { error:"HTTP " + res.status };

      const data = await res.json();
      const item = data?.item;
      const isPlaying = Boolean(data?.is_playing && item);

      if (!isPlaying) return { isPlaying:false };

      return {
        isPlaying:true,
        artist: (item.artists || []).map(a=>a.name).join(", "),
        track: item.name || "—",
        imageUrl: item.album?.images?.[0]?.url || ""
      };
    }

    async function ensureToken(){
      let token = getAccessToken();
      if (!token) return null;
      if (tokenExpired()){
        token = await refreshAccessToken();
      }
      return token;
    }

    let pollTimer = null;
    async function startPolling(){
      if (pollTimer) clearInterval(pollTimer);

      async function tick(){
        const token = await ensureToken();

        // brak tokena -> AUTO CONNECT (czyli redirect do logowania)
        if (!token){
          // żeby nie robić pętli redirectów (np. gdy streamlabs blokuje popup),
          // ustawiamy mały “bezpiecznik”:
          const tried = sessionStorage.getItem("sp_tried_login");
          if (!tried){
            sessionStorage.setItem("sp_tried_login","1");
            setIdle("Loguję do Spotify…", "Jeśli to 1. raz: zaakceptuj zgodę");
            await startLoginAuto();
            return;
          } else {
            // jak już próbowaliśmy w tej sesji i nie poszło, pokaż sensowny tekst
            setIdle("Brak autoryzacji", "Otwórz overlay w przeglądarce i zaloguj");
            return;
          }
        }

        pill.textContent = "ON";
        const result = await spotifyCurrentlyPlaying(token);

        if (result.unauthorized){
          const refreshed = await refreshAccessToken();
          if (!refreshed){
            clearTokens();
            setIdle("Sesja wygasła", "Odśwież overlay / zaloguj ponownie");
          }
          return;
        }

        if (result.isPlaying){
          setPlaying(result);
        } else {
          setIdle("Nic nie gra", "albo masz pauzę");
        }
      }

      await tick();
      pollTimer = setInterval(tick, 5000);
    }

    (async function init(){
      setIdle("Spotify", "Łączenie…");
      resizeCardToText();
      await handleCallbackIfNeeded();
      await startPolling();
    })();
  </script>
</body>
</html>


